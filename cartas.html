<script>
  // gera 10 campos de dica
  (function(){
    const c=document.getElementById('dicasCamposD');
    for(let i=1;i<=10;i++){
      const inp=document.createElement('input');
      inp.type='text'; inp.id='Dica'+i; inp.placeholder='Dica '+i;
      c.appendChild(inp);
    }
  })();

  // busca imagem externa e converte em data URL (para evitar problemas de CORS no html2canvas)
  async function fetchImageAsDataURL(url) {
    try {
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error('Falha ao carregar imagem');
      const blob = await res.blob();
      return await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = () => reject('Erro ao converter imagem');
        reader.readAsDataURL(blob);
      });
    } catch (e) {
      console.warn('Não foi possível converter a imagem, usando placeholder:', e);
      return 'https://via.placeholder.com/300x200';
    }
  }

  async function atualizarCarta(pref){
    const carta=document.getElementById('carta'+pref);
    const t=document.getElementById('titulo'+pref).value,
          s=document.getElementById('subtitulo'+pref).value,
          u=document.getElementById('imagem'+pref).value,
          bg=document.getElementById('corFundo'+pref).value,
          fg=document.getElementById('corTexto'+pref).value;

    document.getElementById('tituloPreview'+pref).innerText = t || 'Nome da Carta';
    document.getElementById('subtituloPreview'+pref).innerText = s || 'Descrição da carta aqui.';
    carta.style.background = bg;
    carta.style.color = fg;

    // processa a imagem (converte para data URL para evitar taint)
    const imgEl = document.getElementById('imgPreview'+pref);
    if (u && u.trim() !== '') {
      const dataUrl = await fetchImageAsDataURL(u.trim());
      imgEl.src = dataUrl;
    } else {
      imgEl.src = 'https://via.placeholder.com/300x200';
    }

    // atualiza lista de dicas (fixo para 'D' no id de lista atual)
    const lst = document.getElementById('listaDicasPreviewD');
    lst.innerHTML='';
    for(let i=1;i<=10;i++){
      const v=document.getElementById('Dica'+i).value.trim() || ('Dica '+i);
      const li=document.createElement('li');
      li.textContent = v;
      lst.appendChild(li);
    }
  }

  function exportarCarta(pref){
    html2canvas(document.getElementById('carta'+pref)).then(canvas=>{
      const a=document.createElement('a');
      a.download = 'carta-dicas.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
    }).catch(err => {
      console.error('Erro ao exportar carta:', err);
      alert('Ocorreu um erro ao exportar a carta. Tente novamente.');
    });
  }
</script>
